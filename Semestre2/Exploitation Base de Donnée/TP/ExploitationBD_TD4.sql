

select distinct di.numfo
    from BASETD.commune co, BASETD.operateur op,BASETD.distribution di
        where op.numfo = di.numfo
        and di.code_insee = co.code_insee
        and op.generation in ('5G','4G')
        and co.nomdep = 'Loire-Atlantique';

create TABLE CommuneLA as select *
                            from basetd.commune co
                                where co.code_insee in (select distinct co.code_insee
                                                            from BASETD.commune co, BASETD.operateur op,BASETD.distribution di
                                                                where op.numfo = di.numfo
                                                                and di.code_insee = co.code_insee
                                                                and op.generation in ('5G','4G')
                                                                and co.nomdep = 'Loire-Atlantique') ;

create TABLE OperateurLA as select * from basetd.operateur op where op.generation in ('5G','4G');

create TABLE DistributionLA as select *
                                from basetd.distribution di
                                    where di.code_insee in (select co.code_insee from CommuneLA co)
                                    and  di.numfo in (select op.numfo from OperateurLA op);

    ---Exercice1---

--Question1--
GRANT SELECT On CommuneLA to Jules;
GRANT SELECT On OperateurLA to I2A08B;
GRANT SELECT On DistributionLA to I2A08B;

--Question2--
GRANT UPDATE(Adresse) on DistributionLA to I2A08B;

--Question3--
GRANT INSERT on DistributionLA to I2A08B;

--Question4--
REVOKE SELECT on CommuneLA from I2A08B;
REVOKE SELECT on OperateurLA from I2A08B;
REVOKE SELECT on DistributionLA from I2A08B;
REVOKE UPDATE on DistributionLA from I2A08B;
REVOKE INSERT on DistributionLA from I2A08B;

--Question5--
select * from DistributionLA;

REVOKE SELECT on DistributionLA from I2A08B;
REVOKE REFERENCES from I2A08B;

create or replace view DistributionLA2 as select di.ID,di.NUMFO,di.CODE_INSEE,di.ADRESSE,di.STATUT from DISTRIBUTIONLA di;
GRANT SELECT on DistributionLA2 to I2A08B;
select * from I2A08B.DistributionVE2;

--Question 6--
select * from DistributionLA;

create or replace view Antenne4GLA as select co.nom_commune,co.CODE_INSEE, (select count(*)
                                            from distributionLA di, operateurLA op
                                                where co.code_insee = di.code_insee
                                                and di.numfo = op.numfo
                                                and op.generation = '4G')quatreG
    from CommuneLA co
            order by 2 desc ;

create or replace view Antenne5GLA as select co.nom_commune,co.code_insee, (select count(*)
                                            from distributionLA di, operateurLA op
                                                where co.code_insee = di.code_insee
                                                and di.numfo = op.numfo
                                                and op.generation = '5G')cinqG
    from CommuneLA co
            order by 2 desc;

create table AntenneTotalLA as select an4.nom_commune , quatreG, cinqG
    from Antenne4GLA an4, Antenne5GLA an5
        where an4.code_insee = an5.code_insee
            order by 2 desc , 3 desc;

GRANT SELECT on AntenneTotalLA to I2A08B;
select * from I2A08B.AntenneTotalVE;

--Question 7--

create or replace view Antenne4GLAop as select co.nom_commune, co.code_insee, op.nomfo, count(*) "Count4G"
                                        from CommuneLA co, operateurLA op, distributionLA di
                                            where op.generation = '4G'
                                                and di.numfo = op.numfo
                                                and co.code_insee = di.code_insee
                                                and di.numfo = op.numfo
                                                    group by co.nom_commune, co.code_insee, op.nomfo
                                                        order by 4 desc ;

create or replace view Antenne5GLAop as select co.nom_commune, co.code_insee, op.nomfo, count(*) "Count5G"
                                        from CommuneLA co, operateurLA op, distributionLA di
                                        where op.generation = '5G'
                                            and di.numfo = op.numfo
                                            and co.code_insee = di.code_insee
                                            and di.numfo = op.numfo
                                        group by co.nom_commune, co.code_insee, op.nomfo
                                        order by 4 desc;


--Question8--
create or replace view Antenne4GLATech as select co.nom_commune, co.code_insee, op.nomfo, op.technologie , count(*) "nb antenne"
                                        from CommuneLA co, operateurLA op, distributionLA di
                                        where op.generation = '4G'
                                            and di.numfo = op.numfo
                                            and co.code_insee = di.code_insee
                                            and di.numfo = op.numfo
                                        group by co.nom_commune, co.code_insee, op.nomfo, op.technologie
                                        order by 5 desc ;

create or replace view Antenne5GLATech as select co.nom_commune, co.code_insee, op.nomfo, op.technologie , count(*) "nb antenne"
                                        from CommuneLA co, operateurLA op, distributionLA di
                                        where op.generation = '5G'
                                            and di.numfo = op.numfo
                                            and co.code_insee = di.code_insee
                                            and di.numfo = op.numfo
                                        group by co.nom_commune, co.code_insee, op.nomfo, op.technologie
                                        order by 5 desc ;

--Question9--
create or replace view Antenne5G20premiers as select cinq.*,quatre."Count4G" from Antenne5GLAop cinq, Antenne4GLAop quatre
                                            where cinq.nomfo = 'ORANGE'
                                            fetch next 20 rows only;


REVOKE SELECT on AntenneTotalLA from i2a08B;
REVOKE SELECT on DistributionLA2 from I2A08B;

---Exercice 2---
--Question1--
REVOKE I2A08BMon_Ami from I2A08B;
DROP Role I2A08BMon_Ami;

CREATE ROLE I2A08BMon_Ami;
grant SELECT on DistributionLA to I2A08BMon_Ami;
SET role I2A08BMon_Ami;
grant I2A08BMon_Ami to i2a08B;

--Question2--
GRANT SELECT On CommuneLA to I2A08BMon_Ami;
GRANT SELECT On OperateurLA to I2A08BMon_Ami;
GRANT SELECT On DistributionLA to I2A08BMon_Ami;

GRANT UPDATE(Adresse) on DistributionLA to I2A08BMon_Ami;
GRANT INSERT on DistributionLA to I2A08BMon_Ami;

--Question3--
REVOKE SELECT on CommuneLA from I2A08BMon_Ami;
Revoke SELECT on OperateurLA from I2A08BMon_Ami;
Revoke SELECT on DistributionLA from I2A08BMon_Ami;

--Question4--
CREATE ROLE I2A08BVoir_mes_tables;

GRANT SELECT On CommuneLA to I2A08BVoir_mes_tables;
GRANT SELECT On OperateurLA to I2A08BVoir_mes_tables;
GRANT SELECT On DistributionLA to I2A08BVoir_mes_tables;

CREATE ROLE I2A08BMAJ_mes_tables;

GRANT UPDATE(Adresse) on DistributionLA to I2A08BMAJ_mes_tables;
GRANT INSERT on DistributionLA to I2A08BMAJ_mes_tables;

--Question7--
CREATE ROLE I2A08BVoir_Update;

GRANT I2A08BVoir_mes_tables, I2A08BMAJ_mes_tables to I2A08BVoir_Update;

--Question9--
DROP Role  I2A08BMAJ_mes_tables;
DROP Role I2A08BVoir_mes_tables;