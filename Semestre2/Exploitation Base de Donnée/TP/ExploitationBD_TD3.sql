---Question 1---
--A--
create or replace view VueCarquefou as (select co.nom_commune,co.code_insee, op.nomfo, op.generation, op.technologie, de.nomdep,
                              de.code_departement, di.adresse
                            from commune co, departement de, operateur op, distribution di
                                where op.numfo=di.numfo
                                and co.code_insee=di.code_insee
                                and co.nomdep=de.nomdep
                                and op.generation ='5G'
                                and co.nom_commune='Carquefou');

create table distribution as (select * from basetd.distribution);
create table operateur as (select * from basetd.operateur);
create table departement as (select * from basetd.departement);
create table commune as (select * from basetd.commune);


--B--
select count(v.generation) from VueCarquefou v;

--C--
select v.nomfo, count(*)
    from VueCarquefou v
        group by v.nomfo;

---Question2---
--A--
create or replace view Best10 as (select co.nom_commune, count(op.generation)
                                    from commune co, departement de, operateur op, distribution di
                                        where op.numfo=di.numfo
                                        and co.code_insee=di.code_insee
                                        and co.nomdep=de.nomdep and generation='5G'
                                            group by co.nom_commune order by 2 desc, 1 FETCH NEXT 10 ROWS ONLY);

select * from Best10
    order by 1;

---Question3---
create or replace view NB5G as select co.code_insee,co.nom_commune, (select count(*) from distribution di, operateur op where op.numfo=di.numfo and co.code_insee=di.code_insee and op.generation='5G' ) nb5G
                                    from commune co
                                        where co.nomdep='Loire-Atlantique'
                                            order by 2 desc;

create or replace view NB4G as select co.code_insee, co.nom_commune, (select count(*) from distribution di, operateur op where op.numfo=di.numfo and co.code_insee=di.code_insee and op.generation='4G' ) nb4G
                                    from commune co
                                        where co.nomdep='Loire-Atlantique'
                                            order by 2 desc;

select n4.nom_commune, n4.nb4G, n5.nb5G
    from  NB4G n4, nb5G n5
        where n4.nom_commune = n5.nom_commune
            order by 3 desc, 1 fetch next 10 rows only;

    --- Exercice 2 ---
---Question 1---
insert into NB5G values(44999,'fontome',200);

---Question 2---
create or replace view CommuneLA as
    select co.* from commune co, departement de
        where co.nomdep=de.nomdep
        and co.nomdep = 'Loire-Atlantique';

alter table departement add constraint pk_nomdep primary key (nomdep);
alter table commune add constraint fk_nomdep foreign key (nomdep) references departement (nomdep);

insert into CommuneLA values(44119,'fontome2','Loire-Atlantique');

drop view CommuneLA;

select * from commune;

--- Exercice 3---
Create table CommuneLoireAtlantique as select * from basetd.commune co where nomdep='Loire-Atlantique';
create table operateurLA as select * from operateur;
Create table distributionLA as
        select *
            from basetd.distribution di
                where di.code_insee in (select code_insee from CommuneLoireAtlantique)
                and di.numfo in (select numfo from operateurLA);

drop table departement;
drop table commune;
drop table distribution;

delete from OPERATEURLA where generation in ('2G','3G');
delete from DISTRIBUTIONLA where numfo in (select op.numfo
                                            from operateurLA op
                                                where op.GENERATION in ('2G','3G'));

select op.numfo
    from operateurLA op
        where op.GENERATION in ('2G','3G');


select * from distributionLA;